Bootstrap: docker
From: rapidsai/rapidsai:cuda10.2-base-centos7-py3.8


# %setup → %post → %files → %test → [RUN] → $help →  %labels → %environment → % startscript→ %runscript


%setup


%post -c /bin/bash
    ## PATHs
    export PATH=/opt/conda/envs/rapids/bin:/opt/conda/bin:$HOME/.local/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/lib:/usr/local/lib64
    export PYTHONPATH=''
    export CUDA_HOME=/user/local/cuda

    echo export PATH=$PATH >> $SINGULARITY_ENVIRONMENT
    echo export LD_LIBRARY_PATH=$LD_LIBRARY_PATH >> $SINGULARITY_ENVIRONMENT
    echo export PYTHON_PATH=$PYTHON_PATH >> $SINGULARITY_ENVIRONMENT
    echo export CUDA_HOME=$CUDA_HOME >> $SINGULARITY_ENVIRONMENT
    echo export LC_ALL=$LC_ALL >> $SINGULARITY_ENVIRONMENT


    ## Command Line Prompt
    CUSTOM_ENV_FILE=/.singularity.d/env/99-zz_custom_env.sh
    cat >$CUSTOM_ENV_FILE <<EOF
#!/bin/bash
PS1="(S)\W \$ "
EOF
    chmod 755 $CUSTOM_ENV_FILE


    ## Preparation
    echo > /etc/hosts
    yum -y install setup
    yum -y update
    yum -y groupinstall "Development Tools"


    ## Locale; en_US.UTF-8
    # https://www.tecmint.com/fix-failed-to-set-locale-defaulting-to-c-utf-8-in-centos/
    yum -y install langpacks-en glibc-all-langpacks
    export LC_ALL=en_US.UTF-8 # C # https://github.com/hpcng/singularity/issues/11
    echo export LC_ALL=$LC_ALL >> $SINGULARITY_ENVIRONMENT


    ## Misc
    yum -y install tkinter
    yum -y install mesa-libGL
    

    ## Python
    # init pip
    python3 -m pip install --upgrade pip
    # conda
    source activate rapids
    conda update -n base -c defaults conda
    conda config --append channels conda-forge
    # install python packages
    conda install -c pytorch-nightly pytorch torchvision



    conda install -y -c dglteam dgl-cuda10.2 # graph neural network
    conda install -y catboost
    conda install -y cython
    conda install -y h5py
    conda install -y jupyter
    conda install -y jupyterlab
    conda install -y lightgbm
    conda install -y matplotlib
    conda install -y mne
    conda install -y natsort
    conda install -y nbconvert
    conda install -y numpy
    conda install -y nbformat
    conda install -y numba
    conda install -y obspy
    python3 -m pip install hydra-core
    conda install -y omegaconf
    conda install -y opencv
    conda install -y pandas
    conda install -y Pillow
    conda install -y plotly
    conda install -y -c gwerbin pyro-ppl
    conda install -y pyyaml
    conda install -y scikit-learn
    conda install -y seaborn
    conda install -y shap
    conda install -y six
    # conda install -y tensorflow-gpu
    conda install -y -c conda-forge pytorch-lightning
    conda install -y tqdm
    conda install -y umap-learn
    conda install -y wandb
    conda install -y xarray
    conda install -c conda-forge resampy
    
    ## Metadata for This Container
    NOW=`date`
    echo "export CONTAINER_BUILD_DATE=\"${NOW}\"" >> $SINGULARITY_ENVIRONMENT


%files


%test


%help
    Developing Container for PAC_Net


%labels
    Author y-watanabe@pgv.co.jp
    Version 0.0.0


%environment


%startscript
    source activate rapids

%runscript
    source activate rapids
    echo "Container was created $NOW"
    echo "\n --- Rapids environment was activated --- \n"