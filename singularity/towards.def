Bootstrap: docker
From: nvidia/cuda:10.2-cudnn7-devel-centos8


%setup


%post -c /bin/bash
    ################################################################################
    ## CentOS
    ################################################################################    
    echo > /etc/hosts
    yum -y install setup
    yum -y update


    ##############################
    ## yum repos
    ##############################
    yum -y install dnf-plugins-core
    yum config-manager --set-enabled powertools
    yum -y install epel-release
    yum -y update


    ##############################
    ## Locale: en_US.UTF-8
    ##############################
    yum -y install langpacks-en glibc-all-langpacks
    export LC_ALL=en_US.UTF-8
    echo export LC_ALL=$LC_ALL >> $SINGULARITY_ENVIRONMENT


    ################################################################################
    ## FFMpeg
    ################################################################################
    yum config-manager --add-repo=https://negativo17.org/repos/epel-multimedia.repo
    yum install -y ffmpeg ffmpeg-devel
    echo `which ffmpeg`


    ################################################################################
    ## Octave
    ################################################################################
    yum -y install octave # 5.2.0


    ################################################################################
    ## Python
    ################################################################################
    yum -y install python38 python38-devel
    ln -s /usr/bin/python3 /usr/bin/python # alias        
    yum -y install python38-tkinter        

    
    ## packages
    python3 -m pip install --upgrade pip
    python3 -m pip install octave_kernel
    python3 -m pip install jupyter
    python3 -m pip install matplotlib
    python3 -m pip install natsort
    python3 -m pip install numpy
    python3 -m pip install pandas

    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH    
    python3 -m pip install torch torchvision
    python3 -m pip install scikit-learn
    python3 -m pip install seaborn
    python3 -m pip install tqdm
    python3 -m pip install h5py
    python3 -m pip install black
    python3 -m pip install numba
    python3 -m pip install PyYAML
    python3 -m pip install ffmpeg-python
    python3 -m pip install ipython
    python3 -m pip install scikit-image
    python3 -m pip install cleanlab
    python3 -m pip install ipdb
    python3 -m pip install statsmodels
    python3 -m pip install chardet
    python3 -m pip install cElementTree
    python3 -m pip install swifter
    python3 -m pip install ripple_detector_CNN    
    

    ################################################################################
    ## PS1
    ################################################################################
    CUSTOM_PS1_FILE=/.singularity.d/env/99-zz-01_custom_ps1.sh
    cat << "    EOH" | awk '{$1=$1;print}' > $CUSTOM_PS1_FILE        
    #!/bin/bash
    
    PS1="(S)\W \$ "
    
    ## EOF
    EOH

    chmod 755 $CUSTOM_PS1_FILE


%files


%test


%help
    A container for the paper "Towards threshold invariance in defining hippocampal ripples."


%labels
    Author ywata1989@gmail.com
    Version 0.1.1


%environment
    # This section will be appended to /.singularity.d/env/90-environment.sh in the
    # container. Then, sh files under /.singularity.d/env/ are sourced in the alpha-numerical order

    ################################################################################
    ## PATHs
    ################################################################################
    export PATH=/usr/local/cuda/bin:$PATH    
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
    export PYTHONPATH=''

    ################################################################################
    ## Meta
    ################################################################################
    export CONTAINER_BUILD_DATE=\"`date`\"


%startscript


%runscript





'''
sudo /opt/bin/singularity exec --writable ./singularity/towards python3 -m pip install PyYAML

sbuild ./singularity/towards.def -f
sshell

sbuildw ./singularity/towards.def

sshellw ./singularity/towards
'''

